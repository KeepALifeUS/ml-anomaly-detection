# ðŸš€ ML Anomaly Detection System - Docker Compose
version: '3.8'

services:
 # Main anomaly detection service
 anomaly-detection:
 build:
 context: .
 dockerfile: Dockerfile
 container_name: ml-anomaly-detection
 ports:
 - '8000:8000' # API port
 - '9090:9090' # Prometheus metrics
 environment:
 - DB_HOST=postgres
 - DB_PORT=5432
 - DB_NAME=ml_anomalies
 - DB_USER=ml
 - DB_PASSWORD=ml_password
 - REDIS_HOST=redis
 - REDIS_PORT=6379
 - API_HOST=0.0.0.0
 - API_PORT=8000
 volumes:
 - ./data:/app/data
 - ./logs:/app/logs
 - ./config.yml:/app/config.yml:ro
 depends_on:
 - postgres
 - redis
 restart: unless-stopped
 networks:
 - ml-network
 healthcheck:
 test: ['CMD', 'curl', '-f', 'http://localhost:8000/health']
 interval: 30s
 timeout: 10s
 retries: 3
 start_period: 30s

 # PostgreSQL database for persistent storage
 postgres:
 image: postgres:15-alpine
 container_name: ml-postgres
 environment:
 - POSTGRES_DB=ml_anomalies
 - POSTGRES_USER=ml
 - POSTGRES_PASSWORD=ml_password
 volumes:
 - postgres_data:/var/lib/postgresql/data
 - ./sql/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
 ports:
 - '5432:5432'
 restart: unless-stopped
 networks:
 - ml-network
 healthcheck:
 test: ['CMD-SHELL', 'pg_isready -U ml -d ml_anomalies']
 interval: 10s
 timeout: 5s
 retries: 5

 # Redis for caching and real-time data
 redis:
 image: redis:7-alpine
 container_name: ml-redis
 ports:
 - '6379:6379'
 volumes:
 - redis_data:/data
 restart: unless-stopped
 networks:
 - ml-network
 healthcheck:
 test: ['CMD', 'redis-cli', 'ping']
 interval: 10s
 timeout: 3s
 retries: 5
 command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru

 # Prometheus for metrics collection
 prometheus:
 image: prom/prometheus:latest
 container_name: ml-prometheus
 ports:
 - '9091:9090'
 volumes:
 - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
 - prometheus_data:/prometheus
 command:
 - '--config.file=/etc/prometheus/prometheus.yml'
 - '--storage.tsdb.path=/prometheus'
 - '--web.console.libraries=/etc/prometheus/console_libraries'
 - '--web.console.templates=/etc/prometheus/consoles'
 - '--storage.tsdb.retention.time=200h'
 - '--web.enable-lifecycle'
 restart: unless-stopped
 networks:
 - ml-network

 # Grafana for visualization
 grafana:
 image: grafana/grafana:latest
 container_name: ml-grafana
 ports:
 - '3001:3000'
 environment:
 - GF_SECURITY_ADMIN_PASSWORD=ml_admin
 volumes:
 - grafana_data:/var/lib/grafana
 - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
 - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
 restart: unless-stopped
 networks:
 - ml-network
 depends_on:
 - prometheus

 # Jaeger for distributed tracing
 jaeger:
 image: jaegertracing/all-in-one:latest
 container_name: ml-jaeger
 ports:
 - '16686:16686' # Jaeger UI
 - '14268:14268' # HTTP collector
 environment:
 - COLLECTOR_OTLP_ENABLED=true
 restart: unless-stopped
 networks:
 - ml-network

 # Nginx reverse proxy
 nginx:
 image: nginx:alpine
 container_name: ml-nginx
 ports:
 - '80:80'
 - '443:443'
 volumes:
 - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
 - ./nginx/ssl:/etc/nginx/ssl:ro
 depends_on:
 - anomaly-detection
 - grafana
 restart: unless-stopped
 networks:
 - ml-network

volumes:
 postgres_data:
 driver: local
 redis_data:
 driver: local
 prometheus_data:
 driver: local
 grafana_data:
 driver: local

networks:
 ml-network:
 driver: bridge
 ipam:
 config:
 - subnet: 172.20.0.0/16
